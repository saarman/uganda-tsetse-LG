---
title: "Uganda tsetse population genetics"
author: "Norah Saarman"
date: "2025-06-03"
output: pdf_document
---

RStudio Configuration:
   - **R version:** R 4.4.0 (Geospatial packages)  
   - **Number of cores:** 4 (up to 32 available)   
   - **Account:** saarman-np  
   - **Partition:** saarman-shared-np (allows multiple simultaneous jobs)  
   - **Memory per job:** 100G (cluster limit: 1000G total; avoid exceeding half)

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, warning=FALSE, results=FALSE, message=FALSE}
library(adegenet)
library(geosphere)
library(igraph)
library(scatterplot3d)

require(ggplot2)
require(dplyr)

#library(hierfstat)
#require(pegas)       
#require(PopGenReport)
#require(poppr) 
```

# Importing data as genind object from .gen
```{R, import}
# 1. Genepop .gen file "./input/Gff_11loci_allsites_genepop.gen" 
Gff.genind <- read.genepop("../input/Gff_11loci_allsites_genepop.gen", ncode = 3)

# Metadata with base R function read.csv()
Gff <- read.csv("../input/Gff_11loci_allsites_indinfo.txt", header=TRUE, sep = "\t")

# Add site code to @pop slot
Gff.genind@pop <- as.factor(Gff$SiteCode)

# Check genind object
Gff.genind
summary(Gff.genind)
```

# Visualize genetic variation with PCA

All samples:
```{r pca-all}
# replace NAs with locus means for PCA
gen_tab <- tab(Gff.genind, NA.method = "mean")  

# Compute PCA on the subset
pca_result3 <- dudi.pca(gen_tab, cent = FALSE, scale = TRUE, scannf = FALSE, nf = 4)

# Extract percent variance explained for PC1 and PC2
var_explained <- round(100 * pca_result3$eig / sum(pca_result3$eig), 1)

# Generate ~86 visually distinct colors
set.seed(123)  # for reproducibility
n_pops <- nlevels(pop(Gff.genind))
color_palette <- colorRampPalette(c("red", "orange", "yellow", "green", "cyan", "blue", "purple"))(n_pops)

# Map population levels to colors
site_levels <- levels(pop(Gff.genind))
site_colors <- setNames(color_palette, site_levels)

# Get color for each individual
pop_colors <- site_colors[as.character(pop(Gff.genind))]

# Layout: 2 panels (main plot + legend)
layout(matrix(c(1, 2), nrow = 1), widths = c(6, 2))

# PCA plot
#pdf("../figures/PCA-all-2D.pdf", width = 14, height = 10)
par(mar = c(5, 4, 4, 2))
plot(pca_result3$li[, 1:2],
     col = pop_colors,
     pch = 19,
     xlab = paste0("PC1 (", var_explained[1], "%)"),
     ylab = paste0("PC2 (", var_explained[2], "%)"))

# Legend panel
par(mar = c(1,1,1,1))  # increase space to avoid clipping
plot.new()
legend("center", 
       legend = site_levels,
       col = site_colors,
       pch = 19,
       cex = 0.6,
       title = "Populations", 
       ncol = 3,
       bty = "n")  # <- no border
#dev.off()

# 3D PCA plot
#pdf("../figures/PCA-all-3D.pdf", width = 14, height = 10)
par(mar = c(5, 4, 4, 2))
s3d <- scatterplot3d(pca_result3$li[, 1:3],
                     color = pop_colors,
                     pch = 19,
                     xlab = paste0("PC1 (", var_explained[1], "%)"),
                     ylab = paste0("PC2 (", var_explained[2], "%)"),
                     zlab = paste0("PC3 (", var_explained[3], "%)"),
                     angle = 55,
                     box = TRUE)

# Legend panel
par(mar = c(1, 1, 1, 1))
plot.new()
legend("center",
       legend = site_levels,
       col = site_colors,
       pch = 19,
       cex = 0.6,
       title = "Populations",
       ncol = 3,
       bty = "n")


#dev.off()

```

Subset of northern cluster at K=2:
  
Subset of southern cluster at K=2: